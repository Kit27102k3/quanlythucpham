"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.updateSavedVoucherStatus = exports.saveVoucher = exports.getUserSavedVouchers = exports.deleteSavedVoucher = exports.deleteExpiredVouchers = void 0;var _SavedVoucher = _interopRequireDefault(require("../Model/SavedVoucher.js"));
var _Coupon = _interopRequireDefault(require("../Model/Coupon.js"));
var _mongoose = _interopRequireDefault(require("mongoose"));

// Lấy danh sách voucher đã lưu của người dùng
const getUserSavedVouchers = async (req, res) => {
  try {
    const userId = req.user.id;

    // Lấy chỉ những voucher chưa sử dụng (isPaid = false)
    const savedVouchers = await _SavedVoucher.default.find({
      userId,
      isPaid: false
    }).populate({
      path: 'couponId',
      select: '-__v'
    }).sort({ savedAt: -1 });

    if (!savedVouchers || savedVouchers.length === 0) {
      return res.status(200).json({
        success: true,
        data: [],
        message: "Người dùng chưa lưu voucher nào"
      });
    }

    // Kiểm tra trạng thái của từng voucher đã lưu
    const vouchers = savedVouchers.map((savedVoucher) => {
      const coupon = savedVoucher.couponId;
      const now = new Date();
      const isExpired = coupon.expiresAt && new Date(coupon.expiresAt) < now;
      const isActive = coupon.isActive;

      return {
        ...savedVoucher.toObject(),
        couponStatus: {
          isExpired,
          isActive
        }
      };
    });

    return res.status(200).json({
      success: true,
      data: vouchers,
      message: "Lấy danh sách voucher đã lưu thành công"
    });
  } catch (error) {
    console.error("Error getting saved vouchers:", error);
    return res.status(500).json({
      success: false,
      message: "Đã xảy ra lỗi khi lấy danh sách voucher đã lưu"
    });
  }
};

// Lưu voucher cho người dùng
exports.getUserSavedVouchers = getUserSavedVouchers;const saveVoucher = async (req, res) => {
  try {
    const userId = req.user.id;
    const { couponId } = req.body;

    console.log(`Attempting to save voucher for user ${userId}, coupon: ${couponId}`);

    if (!couponId) {
      return res.status(400).json({
        success: false,
        message: "Thiếu thông tin mã giảm giá"
      });
    }

    // Kiểm tra coupon có tồn tại không
    const coupon = await _Coupon.default.findById(couponId);
    if (!coupon) {
      return res.status(404).json({
        success: false,
        message: "Mã giảm giá không tồn tại"
      });
    }

    console.log("Coupon found:", {
      id: coupon._id,
      code: coupon.code,
      usageLimit: coupon.usageLimit,
      used: coupon.used
    });

    // Kiểm tra coupon còn hiệu lực không
    const now = new Date();
    if (coupon.expiresAt && new Date(coupon.expiresAt) < now) {
      return res.status(400).json({
        success: false,
        message: "Mã giảm giá đã hết hạn"
      });
    }

    if (!coupon.isActive) {
      return res.status(400).json({
        success: false,
        message: "Mã giảm giá không còn hiệu lực"
      });
    }

    // Kiểm tra số lượng voucher còn lại
    const currentUsed = coupon.used || 0;
    const usageLimit = coupon.usageLimit;
    console.log(`Voucher usage: ${currentUsed}/${usageLimit}`);

    if (usageLimit && currentUsed >= usageLimit) {
      return res.status(400).json({
        success: false,
        message: "Mã giảm giá đã hết số lượng"
      });
    }

    try {
      // Kiểm tra xem user đã lưu voucher này chưa - Chỉ kiểm tra theo couponId
      const existingSavedVoucher = await _SavedVoucher.default.findOne({
        userId,
        couponId
      });

      console.log("Existing saved voucher check:", existingSavedVoucher ? "Found existing" : "Not found");

      if (existingSavedVoucher) {
        return res.status(400).json({
          success: false,
          message: "Bạn đã lưu mã giảm giá này rồi"
        });
      }

      // Tạo bản ghi lưu voucher mới
      const newSavedVoucher = new _SavedVoucher.default({
        userId,
        couponId,
        savedAt: new Date()
      });

      console.log("Saving new voucher:", newSavedVoucher);
      await newSavedVoucher.save();
      console.log("Saved voucher successfully for user:", userId);

      // Sau khi lưu thành công, mới tăng số lượng đã sử dụng
      coupon.used = currentUsed + 1;
      await coupon.save();
      console.log(`Updated voucher usage to: ${coupon.used}/${usageLimit}`);

      return res.status(201).json({
        success: true,
        data: newSavedVoucher,
        message: "Đã lưu mã giảm giá thành công"
      });

    } catch (error) {
      // Xử lý lỗi
      if (error.code === 11000) {
        // Nếu là lỗi trùng lặp, kiểm tra trường nào bị trùng
        const keyPattern = error.keyPattern;

        // Nếu lỗi chỉ do userId, cho phép lưu
        if (keyPattern && keyPattern.userId && !keyPattern.couponId) {
          // Ignore userId unique constraint
          const savedVoucher = new _SavedVoucher.default({
            _id: new _mongoose.default.Types.ObjectId(), // Tạo ID mới
            userId,
            couponId,
            savedAt: new Date()
          });

          await savedVoucher.save({ checkKeys: false });

          // Cập nhật số lượng sử dụng
          coupon.used = currentUsed + 1;
          await coupon.save();

          return res.status(201).json({
            success: true,
            data: savedVoucher,
            message: "Đã lưu mã giảm giá thành công"
          });
        } else {
          // Nếu lỗi do cả userId và couponId, thì người dùng đã lưu mã này
          return res.status(400).json({
            success: false,
            message: "Bạn đã lưu mã giảm giá này rồi"
          });
        }
      }

      // Lỗi khác
      console.error("Error saving voucher:", error);
      return res.status(500).json({
        success: false,
        message: "Đã xảy ra lỗi khi lưu mã giảm giá: " + error.message
      });
    }
  } catch (mainError) {
    console.error("Unexpected error:", mainError);
    return res.status(500).json({
      success: false,
      message: "Đã xảy ra lỗi không mong muốn: " + mainError.message
    });
  }
};

// Xóa voucher đã lưu
exports.saveVoucher = saveVoucher;const deleteSavedVoucher = async (req, res) => {
  try {
    const userId = req.user.id;
    const { couponId } = req.params;

    if (!couponId) {
      return res.status(400).json({
        success: false,
        message: "Thiếu thông tin mã giảm giá"
      });
    }

    // Tìm voucher đã lưu
    const savedVoucher = await _SavedVoucher.default.findOne({ userId, couponId });

    if (!savedVoucher) {
      return res.status(404).json({
        success: false,
        message: "Không tìm thấy voucher đã lưu"
      });
    }

    // Giảm số lượng đã sử dụng của voucher
    const coupon = await _Coupon.default.findById(couponId);
    if (coupon && coupon.used > 0) {
      coupon.used -= 1;
      await coupon.save();
    }

    // Xóa voucher đã lưu
    await _SavedVoucher.default.findOneAndDelete({ userId, couponId });

    return res.status(200).json({
      success: true,
      message: "Đã xóa voucher đã lưu thành công"
    });
  } catch (error) {
    console.error("Error deleting saved voucher:", error);
    return res.status(500).json({
      success: false,
      message: "Đã xảy ra lỗi khi xóa voucher đã lưu"
    });
  }
};

// Cập nhật trạng thái isPaid của voucher đã lưu
exports.deleteSavedVoucher = deleteSavedVoucher;const updateSavedVoucherStatus = async (req, res) => {
  try {
    const userId = req.user.id;
    const { savedVoucherId } = req.params;
    const { isPaid } = req.body;

    if (isPaid === undefined) {
      return res.status(400).json({
        success: false,
        message: "Thiếu thông tin trạng thái isPaid"
      });
    }

    // Tìm voucher đã lưu
    const savedVoucher = await _SavedVoucher.default.findOne({
      _id: savedVoucherId,
      userId: userId
    });

    if (!savedVoucher) {
      return res.status(404).json({
        success: false,
        message: "Không tìm thấy voucher đã lưu"
      });
    }

    // Cập nhật trạng thái isPaid
    savedVoucher.isPaid = isPaid;
    await savedVoucher.save();

    return res.status(200).json({
      success: true,
      data: savedVoucher,
      message: "Đã cập nhật trạng thái voucher thành công"
    });
  } catch (error) {
    console.error("Error updating saved voucher status:", error);
    return res.status(500).json({
      success: false,
      message: "Đã xảy ra lỗi khi cập nhật trạng thái voucher"
    });
  }
};

// Hàm xóa voucher đã hết hạn
exports.updateSavedVoucherStatus = updateSavedVoucherStatus;const deleteExpiredVouchers = async () => {
  try {
    const now = new Date();

    // Tìm tất cả saved vouchers
    const savedVouchers = await _SavedVoucher.default.find().populate('couponId');

    // Lọc các voucher đã hết hạn
    const expiredVouchers = savedVouchers.filter((savedVoucher) => {
      const coupon = savedVoucher.couponId;
      return coupon && coupon.expiresAt && new Date(coupon.expiresAt) < now;
    });

    // Xóa các voucher đã hết hạn
    if (expiredVouchers.length > 0) {
      const expiredIds = expiredVouchers.map((voucher) => voucher._id);
      const result = await _SavedVoucher.default.deleteMany({ _id: { $in: expiredIds } });
      console.log(`Đã xóa ${result.deletedCount} voucher đã hết hạn.`);
    }

    return true;
  } catch (error) {
    console.error("Error deleting expired vouchers:", error);
    return false;
  }
};exports.deleteExpiredVouchers = deleteExpiredVouchers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfU2F2ZWRWb3VjaGVyIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfQ291cG9uIiwiX21vbmdvb3NlIiwiZ2V0VXNlclNhdmVkVm91Y2hlcnMiLCJyZXEiLCJyZXMiLCJ1c2VySWQiLCJ1c2VyIiwiaWQiLCJzYXZlZFZvdWNoZXJzIiwiU2F2ZWRWb3VjaGVyIiwiZmluZCIsImlzUGFpZCIsInBvcHVsYXRlIiwicGF0aCIsInNlbGVjdCIsInNvcnQiLCJzYXZlZEF0IiwibGVuZ3RoIiwic3RhdHVzIiwianNvbiIsInN1Y2Nlc3MiLCJkYXRhIiwibWVzc2FnZSIsInZvdWNoZXJzIiwibWFwIiwic2F2ZWRWb3VjaGVyIiwiY291cG9uIiwiY291cG9uSWQiLCJub3ciLCJEYXRlIiwiaXNFeHBpcmVkIiwiZXhwaXJlc0F0IiwiaXNBY3RpdmUiLCJ0b09iamVjdCIsImNvdXBvblN0YXR1cyIsImVycm9yIiwiY29uc29sZSIsImV4cG9ydHMiLCJzYXZlVm91Y2hlciIsImJvZHkiLCJsb2ciLCJDb3Vwb24iLCJmaW5kQnlJZCIsIl9pZCIsImNvZGUiLCJ1c2FnZUxpbWl0IiwidXNlZCIsImN1cnJlbnRVc2VkIiwiZXhpc3RpbmdTYXZlZFZvdWNoZXIiLCJmaW5kT25lIiwibmV3U2F2ZWRWb3VjaGVyIiwic2F2ZSIsImtleVBhdHRlcm4iLCJtb25nb29zZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCJjaGVja0tleXMiLCJtYWluRXJyb3IiLCJkZWxldGVTYXZlZFZvdWNoZXIiLCJwYXJhbXMiLCJmaW5kT25lQW5kRGVsZXRlIiwidXBkYXRlU2F2ZWRWb3VjaGVyU3RhdHVzIiwic2F2ZWRWb3VjaGVySWQiLCJ1bmRlZmluZWQiLCJkZWxldGVFeHBpcmVkVm91Y2hlcnMiLCJleHBpcmVkVm91Y2hlcnMiLCJmaWx0ZXIiLCJleHBpcmVkSWRzIiwidm91Y2hlciIsInJlc3VsdCIsImRlbGV0ZU1hbnkiLCIkaW4iLCJkZWxldGVkQ291bnQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQ29udHJvbGxlci9zYXZlZFZvdWNoZXJDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTYXZlZFZvdWNoZXIgZnJvbSBcIi4uL01vZGVsL1NhdmVkVm91Y2hlci5qc1wiO1xyXG5pbXBvcnQgQ291cG9uIGZyb20gXCIuLi9Nb2RlbC9Db3Vwb24uanNcIjtcclxuaW1wb3J0IG1vbmdvb3NlIGZyb20gXCJtb25nb29zZVwiO1xyXG5cclxuLy8gTOG6pXkgZGFuaCBzw6FjaCB2b3VjaGVyIMSRw6MgbMawdSBj4bunYSBuZ8aw4budaSBkw7luZ1xyXG5leHBvcnQgY29uc3QgZ2V0VXNlclNhdmVkVm91Y2hlcnMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XHJcblxyXG4gICAgLy8gTOG6pXkgY2jhu4kgbmjhu69uZyB2b3VjaGVyIGNoxrBhIHPhu60gZOG7pW5nIChpc1BhaWQgPSBmYWxzZSlcclxuICAgIGNvbnN0IHNhdmVkVm91Y2hlcnMgPSBhd2FpdCBTYXZlZFZvdWNoZXIuZmluZCh7IFxyXG4gICAgICB1c2VySWQsXHJcbiAgICAgIGlzUGFpZDogZmFsc2UgXHJcbiAgICB9KS5wb3B1bGF0ZSh7XHJcbiAgICAgIHBhdGg6ICdjb3Vwb25JZCcsXHJcbiAgICAgIHNlbGVjdDogJy1fX3YnXHJcbiAgICB9KS5zb3J0KHsgc2F2ZWRBdDogLTEgfSk7XHJcblxyXG4gICAgaWYgKCFzYXZlZFZvdWNoZXJzIHx8IHNhdmVkVm91Y2hlcnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBkYXRhOiBbXSxcclxuICAgICAgICBtZXNzYWdlOiBcIk5nxrDhu51pIGTDuW5nIGNoxrBhIGzGsHUgdm91Y2hlciBuw6BvXCJcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPhu6dhIHThu6tuZyB2b3VjaGVyIMSRw6MgbMawdVxyXG4gICAgY29uc3Qgdm91Y2hlcnMgPSBzYXZlZFZvdWNoZXJzLm1hcChzYXZlZFZvdWNoZXIgPT4ge1xyXG4gICAgICBjb25zdCBjb3Vwb24gPSBzYXZlZFZvdWNoZXIuY291cG9uSWQ7XHJcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgIGNvbnN0IGlzRXhwaXJlZCA9IGNvdXBvbi5leHBpcmVzQXQgJiYgbmV3IERhdGUoY291cG9uLmV4cGlyZXNBdCkgPCBub3c7XHJcbiAgICAgIGNvbnN0IGlzQWN0aXZlID0gY291cG9uLmlzQWN0aXZlO1xyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zYXZlZFZvdWNoZXIudG9PYmplY3QoKSxcclxuICAgICAgICBjb3Vwb25TdGF0dXM6IHtcclxuICAgICAgICAgIGlzRXhwaXJlZCxcclxuICAgICAgICAgIGlzQWN0aXZlXHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgZGF0YTogdm91Y2hlcnMsXHJcbiAgICAgIG1lc3NhZ2U6IFwiTOG6pXkgZGFuaCBzw6FjaCB2b3VjaGVyIMSRw6MgbMawdSB0aMOgbmggY8O0bmdcIlxyXG4gICAgfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIHNhdmVkIHZvdWNoZXJzOlwiLCBlcnJvcik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgbWVzc2FnZTogXCLEkMOjIHjhuqN5IHJhIGzhu5dpIGtoaSBs4bqleSBkYW5oIHPDoWNoIHZvdWNoZXIgxJHDoyBsxrB1XCJcclxuICAgIH0pO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIEzGsHUgdm91Y2hlciBjaG8gbmfGsOG7nWkgZMO5bmdcclxuZXhwb3J0IGNvbnN0IHNhdmVWb3VjaGVyID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xyXG4gICAgY29uc3QgeyBjb3Vwb25JZCB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgY29uc29sZS5sb2coYEF0dGVtcHRpbmcgdG8gc2F2ZSB2b3VjaGVyIGZvciB1c2VyICR7dXNlcklkfSwgY291cG9uOiAke2NvdXBvbklkfWApO1xyXG5cclxuICAgIGlmICghY291cG9uSWQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIlRoaeG6v3UgdGjDtG5nIHRpbiBtw6MgZ2nhuqNtIGdpw6FcIlxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBLaeG7g20gdHJhIGNvdXBvbiBjw7MgdOG7k24gdOG6oWkga2jDtG5nXHJcbiAgICBjb25zdCBjb3Vwb24gPSBhd2FpdCBDb3Vwb24uZmluZEJ5SWQoY291cG9uSWQpO1xyXG4gICAgaWYgKCFjb3Vwb24pIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIk3DoyBnaeG6o20gZ2nDoSBraMO0bmcgdOG7k24gdOG6oWlcIlxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhcIkNvdXBvbiBmb3VuZDpcIiwge1xyXG4gICAgICBpZDogY291cG9uLl9pZCxcclxuICAgICAgY29kZTogY291cG9uLmNvZGUsXHJcbiAgICAgIHVzYWdlTGltaXQ6IGNvdXBvbi51c2FnZUxpbWl0LFxyXG4gICAgICB1c2VkOiBjb3Vwb24udXNlZFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gS2nhu4NtIHRyYSBjb3Vwb24gY8OybiBoaeG7h3UgbOG7sWMga2jDtG5nXHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgaWYgKGNvdXBvbi5leHBpcmVzQXQgJiYgbmV3IERhdGUoY291cG9uLmV4cGlyZXNBdCkgPCBub3cpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIk3DoyBnaeG6o20gZ2nDoSDEkcOjIGjhur90IGjhuqFuXCJcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFjb3Vwb24uaXNBY3RpdmUpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIk3DoyBnaeG6o20gZ2nDoSBraMO0bmcgY8OybiBoaeG7h3UgbOG7sWNcIlxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBLaeG7g20gdHJhIHPhu5EgbMaw4bujbmcgdm91Y2hlciBjw7JuIGzhuqFpXHJcbiAgICBjb25zdCBjdXJyZW50VXNlZCA9IGNvdXBvbi51c2VkIHx8IDA7XHJcbiAgICBjb25zdCB1c2FnZUxpbWl0ID0gY291cG9uLnVzYWdlTGltaXQ7XHJcbiAgICBjb25zb2xlLmxvZyhgVm91Y2hlciB1c2FnZTogJHtjdXJyZW50VXNlZH0vJHt1c2FnZUxpbWl0fWApO1xyXG4gICAgXHJcbiAgICBpZiAodXNhZ2VMaW1pdCAmJiBjdXJyZW50VXNlZCA+PSB1c2FnZUxpbWl0KSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgbWVzc2FnZTogXCJNw6MgZ2nhuqNtIGdpw6EgxJHDoyBo4bq/dCBz4buRIGzGsOG7o25nXCJcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gS2nhu4NtIHRyYSB4ZW0gdXNlciDEkcOjIGzGsHUgdm91Y2hlciBuw6B5IGNoxrBhIC0gQ2jhu4kga2nhu4NtIHRyYSB0aGVvIGNvdXBvbklkXHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nU2F2ZWRWb3VjaGVyID0gYXdhaXQgU2F2ZWRWb3VjaGVyLmZpbmRPbmUoeyBcclxuICAgICAgICB1c2VySWQsIFxyXG4gICAgICAgIGNvdXBvbklkXHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coXCJFeGlzdGluZyBzYXZlZCB2b3VjaGVyIGNoZWNrOlwiLCBleGlzdGluZ1NhdmVkVm91Y2hlciA/IFwiRm91bmQgZXhpc3RpbmdcIiA6IFwiTm90IGZvdW5kXCIpO1xyXG5cclxuICAgICAgaWYgKGV4aXN0aW5nU2F2ZWRWb3VjaGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgbWVzc2FnZTogXCJC4bqhbiDEkcOjIGzGsHUgbcOjIGdp4bqjbSBnacOhIG7DoHkgcuG7k2lcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBU4bqhbyBi4bqjbiBnaGkgbMawdSB2b3VjaGVyIG3hu5tpXHJcbiAgICAgIGNvbnN0IG5ld1NhdmVkVm91Y2hlciA9IG5ldyBTYXZlZFZvdWNoZXIoe1xyXG4gICAgICAgIHVzZXJJZCxcclxuICAgICAgICBjb3Vwb25JZCxcclxuICAgICAgICBzYXZlZEF0OiBuZXcgRGF0ZSgpXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coXCJTYXZpbmcgbmV3IHZvdWNoZXI6XCIsIG5ld1NhdmVkVm91Y2hlcik7XHJcbiAgICAgIGF3YWl0IG5ld1NhdmVkVm91Y2hlci5zYXZlKCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiU2F2ZWQgdm91Y2hlciBzdWNjZXNzZnVsbHkgZm9yIHVzZXI6XCIsIHVzZXJJZCk7XHJcblxyXG4gICAgICAvLyBTYXUga2hpIGzGsHUgdGjDoG5oIGPDtG5nLCBt4bubaSB0xINuZyBz4buRIGzGsOG7o25nIMSRw6Mgc+G7rSBk4bulbmdcclxuICAgICAgY291cG9uLnVzZWQgPSBjdXJyZW50VXNlZCArIDE7XHJcbiAgICAgIGF3YWl0IGNvdXBvbi5zYXZlKCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGVkIHZvdWNoZXIgdXNhZ2UgdG86ICR7Y291cG9uLnVzZWR9LyR7dXNhZ2VMaW1pdH1gKTtcclxuXHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMSkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBkYXRhOiBuZXdTYXZlZFZvdWNoZXIsXHJcbiAgICAgICAgbWVzc2FnZTogXCLEkMOjIGzGsHUgbcOjIGdp4bqjbSBnacOhIHRow6BuaCBjw7RuZ1wiXHJcbiAgICAgIH0pO1xyXG4gICAgXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAvLyBY4butIGzDvSBs4buXaVxyXG4gICAgICBpZiAoZXJyb3IuY29kZSA9PT0gMTEwMDApIHtcclxuICAgICAgICAvLyBO4bq/dSBsw6AgbOG7l2kgdHLDuW5nIGzhurdwLCBraeG7g20gdHJhIHRyxrDhu51uZyBuw6BvIGLhu4sgdHLDuW5nXHJcbiAgICAgICAgY29uc3Qga2V5UGF0dGVybiA9IGVycm9yLmtleVBhdHRlcm47XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gTuG6v3UgbOG7l2kgY2jhu4kgZG8gdXNlcklkLCBjaG8gcGjDqXAgbMawdVxyXG4gICAgICAgIGlmIChrZXlQYXR0ZXJuICYmIGtleVBhdHRlcm4udXNlcklkICYmICFrZXlQYXR0ZXJuLmNvdXBvbklkKSB7XHJcbiAgICAgICAgICAvLyBJZ25vcmUgdXNlcklkIHVuaXF1ZSBjb25zdHJhaW50XHJcbiAgICAgICAgICBjb25zdCBzYXZlZFZvdWNoZXIgPSBuZXcgU2F2ZWRWb3VjaGVyKHtcclxuICAgICAgICAgICAgX2lkOiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQoKSwgLy8gVOG6oW8gSUQgbeG7m2lcclxuICAgICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgICBjb3Vwb25JZCxcclxuICAgICAgICAgICAgc2F2ZWRBdDogbmV3IERhdGUoKVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBcclxuICAgICAgICAgIGF3YWl0IHNhdmVkVm91Y2hlci5zYXZlKHsgY2hlY2tLZXlzOiBmYWxzZSB9KTtcclxuICAgICAgICAgIFxyXG4gICAgICAgICAgLy8gQ+G6rXAgbmjhuq10IHPhu5EgbMaw4bujbmcgc+G7rSBk4bulbmdcclxuICAgICAgICAgIGNvdXBvbi51c2VkID0gY3VycmVudFVzZWQgKyAxO1xyXG4gICAgICAgICAgYXdhaXQgY291cG9uLnNhdmUoKTtcclxuICAgICAgICAgIFxyXG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgZGF0YTogc2F2ZWRWb3VjaGVyLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiBcIsSQw6MgbMawdSBtw6MgZ2nhuqNtIGdpw6EgdGjDoG5oIGPDtG5nXCJcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBO4bq/dSBs4buXaSBkbyBj4bqjIHVzZXJJZCB2w6AgY291cG9uSWQsIHRow6wgbmfGsOG7nWkgZMO5bmcgxJHDoyBsxrB1IG3DoyBuw6B5XHJcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgbWVzc2FnZTogXCJC4bqhbiDEkcOjIGzGsHUgbcOjIGdp4bqjbSBnacOhIG7DoHkgcuG7k2lcIlxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBM4buXaSBraMOhY1xyXG4gICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3Igc2F2aW5nIHZvdWNoZXI6XCIsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIsSQw6MgeOG6o3kgcmEgbOG7l2kga2hpIGzGsHUgbcOjIGdp4bqjbSBnacOhOiBcIiArIGVycm9yLm1lc3NhZ2VcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAobWFpbkVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiVW5leHBlY3RlZCBlcnJvcjpcIiwgbWFpbkVycm9yKTtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBtZXNzYWdlOiBcIsSQw6MgeOG6o3kgcmEgbOG7l2kga2jDtG5nIG1vbmcgbXXhu5FuOiBcIiArIG1haW5FcnJvci5tZXNzYWdlXHJcbiAgICB9KTtcclxuICB9XHJcbn07XHJcblxyXG4vLyBYw7NhIHZvdWNoZXIgxJHDoyBsxrB1XHJcbmV4cG9ydCBjb25zdCBkZWxldGVTYXZlZFZvdWNoZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XHJcbiAgICBjb25zdCB7IGNvdXBvbklkIH0gPSByZXEucGFyYW1zO1xyXG5cclxuICAgIGlmICghY291cG9uSWQpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIlRoaeG6v3UgdGjDtG5nIHRpbiBtw6MgZ2nhuqNtIGdpw6FcIlxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUw6xtIHZvdWNoZXIgxJHDoyBsxrB1XHJcbiAgICBjb25zdCBzYXZlZFZvdWNoZXIgPSBhd2FpdCBTYXZlZFZvdWNoZXIuZmluZE9uZSh7IHVzZXJJZCwgY291cG9uSWQgfSk7XHJcblxyXG4gICAgaWYgKCFzYXZlZFZvdWNoZXIpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiBcIktow7RuZyB0w6xtIHRo4bqleSB2b3VjaGVyIMSRw6MgbMawdVwiXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdp4bqjbSBz4buRIGzGsOG7o25nIMSRw6Mgc+G7rSBk4bulbmcgY+G7p2Egdm91Y2hlclxyXG4gICAgY29uc3QgY291cG9uID0gYXdhaXQgQ291cG9uLmZpbmRCeUlkKGNvdXBvbklkKTtcclxuICAgIGlmIChjb3Vwb24gJiYgY291cG9uLnVzZWQgPiAwKSB7XHJcbiAgICAgIGNvdXBvbi51c2VkIC09IDE7XHJcbiAgICAgIGF3YWl0IGNvdXBvbi5zYXZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gWMOzYSB2b3VjaGVyIMSRw6MgbMawdVxyXG4gICAgYXdhaXQgU2F2ZWRWb3VjaGVyLmZpbmRPbmVBbmREZWxldGUoeyB1c2VySWQsIGNvdXBvbklkIH0pO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIG1lc3NhZ2U6IFwixJDDoyB4w7NhIHZvdWNoZXIgxJHDoyBsxrB1IHRow6BuaCBjw7RuZ1wiXHJcbiAgICB9KTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGRlbGV0aW5nIHNhdmVkIHZvdWNoZXI6XCIsIGVycm9yKTtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBtZXNzYWdlOiBcIsSQw6MgeOG6o3kgcmEgbOG7l2kga2hpIHjDs2Egdm91Y2hlciDEkcOjIGzGsHVcIlxyXG4gICAgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgaXNQYWlkIGPhu6dhIHZvdWNoZXIgxJHDoyBsxrB1XHJcbmV4cG9ydCBjb25zdCB1cGRhdGVTYXZlZFZvdWNoZXJTdGF0dXMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XHJcbiAgICBjb25zdCB7IHNhdmVkVm91Y2hlcklkIH0gPSByZXEucGFyYW1zO1xyXG4gICAgY29uc3QgeyBpc1BhaWQgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgIGlmIChpc1BhaWQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIG1lc3NhZ2U6IFwiVGhp4bq/dSB0aMO0bmcgdGluIHRy4bqhbmcgdGjDoWkgaXNQYWlkXCJcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVMOsbSB2b3VjaGVyIMSRw6MgbMawdVxyXG4gICAgY29uc3Qgc2F2ZWRWb3VjaGVyID0gYXdhaXQgU2F2ZWRWb3VjaGVyLmZpbmRPbmUoeyBcclxuICAgICAgX2lkOiBzYXZlZFZvdWNoZXJJZCxcclxuICAgICAgdXNlcklkOiB1c2VySWRcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICghc2F2ZWRWb3VjaGVyKSB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgbWVzc2FnZTogXCJLaMO0bmcgdMOsbSB0aOG6pXkgdm91Y2hlciDEkcOjIGzGsHVcIlxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBpc1BhaWRcclxuICAgIHNhdmVkVm91Y2hlci5pc1BhaWQgPSBpc1BhaWQ7XHJcbiAgICBhd2FpdCBzYXZlZFZvdWNoZXIuc2F2ZSgpO1xyXG5cclxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIGRhdGE6IHNhdmVkVm91Y2hlcixcclxuICAgICAgbWVzc2FnZTogXCLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHZvdWNoZXIgdGjDoG5oIGPDtG5nXCJcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgdXBkYXRpbmcgc2F2ZWQgdm91Y2hlciBzdGF0dXM6XCIsIGVycm9yKTtcclxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICBtZXNzYWdlOiBcIsSQw6MgeOG6o3kgcmEgbOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHZvdWNoZXJcIlxyXG4gICAgfSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gSMOgbSB4w7NhIHZvdWNoZXIgxJHDoyBo4bq/dCBo4bqhblxyXG5leHBvcnQgY29uc3QgZGVsZXRlRXhwaXJlZFZvdWNoZXJzID0gYXN5bmMgKCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgXHJcbiAgICAvLyBUw6xtIHThuqV0IGPhuqMgc2F2ZWQgdm91Y2hlcnNcclxuICAgIGNvbnN0IHNhdmVkVm91Y2hlcnMgPSBhd2FpdCBTYXZlZFZvdWNoZXIuZmluZCgpLnBvcHVsYXRlKCdjb3Vwb25JZCcpO1xyXG4gICAgXHJcbiAgICAvLyBM4buNYyBjw6FjIHZvdWNoZXIgxJHDoyBo4bq/dCBo4bqhblxyXG4gICAgY29uc3QgZXhwaXJlZFZvdWNoZXJzID0gc2F2ZWRWb3VjaGVycy5maWx0ZXIoc2F2ZWRWb3VjaGVyID0+IHtcclxuICAgICAgY29uc3QgY291cG9uID0gc2F2ZWRWb3VjaGVyLmNvdXBvbklkO1xyXG4gICAgICByZXR1cm4gY291cG9uICYmIGNvdXBvbi5leHBpcmVzQXQgJiYgbmV3IERhdGUoY291cG9uLmV4cGlyZXNBdCkgPCBub3c7XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgLy8gWMOzYSBjw6FjIHZvdWNoZXIgxJHDoyBo4bq/dCBo4bqhblxyXG4gICAgaWYgKGV4cGlyZWRWb3VjaGVycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IGV4cGlyZWRJZHMgPSBleHBpcmVkVm91Y2hlcnMubWFwKHZvdWNoZXIgPT4gdm91Y2hlci5faWQpO1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTYXZlZFZvdWNoZXIuZGVsZXRlTWFueSh7IF9pZDogeyAkaW46IGV4cGlyZWRJZHMgfSB9KTtcclxuICAgICAgY29uc29sZS5sb2coYMSQw6MgeMOzYSAke3Jlc3VsdC5kZWxldGVkQ291bnR9IHZvdWNoZXIgxJHDoyBo4bq/dCBo4bqhbi5gKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBkZWxldGluZyBleHBpcmVkIHZvdWNoZXJzOlwiLCBlcnJvcik7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59OyAiXSwibWFwcGluZ3MiOiI0VEFBQSxJQUFBQSxhQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxPQUFBLEdBQUFGLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBRSxTQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7O0FBRUE7QUFDTyxNQUFNRyxvQkFBb0IsR0FBRyxNQUFBQSxDQUFPQyxH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