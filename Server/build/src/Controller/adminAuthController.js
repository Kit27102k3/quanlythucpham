"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.adminLogin = void 0;var _adminModel = _interopRequireDefault(require("../Model/adminModel.js"));
var _bcryptjs = _interopRequireDefault(require("bcryptjs"));
var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));
var _dotenv = _interopRequireDefault(require("dotenv"));
var _RefreshToken = _interopRequireDefault(require("../Model/RefreshToken.js"));function _interopRequireDefault(e) {return e && e.__esModule ? e : { default: e };}

_dotenv.default.config();

const adminLogin = async (req, res) => {
  try {
    const { userName, password } = req.body;

    // Tìm admin theo username
    const admin = await _adminModel.default.findOne({ userName });
    if (!admin) {
      return res.status(401).json({ message: "Tên đăng nhập hoặc mật khẩu không chính xác" });
    }

    // Kiểm tra mật khẩu
    const isMatch = await admin.comparePassword(password);
    if (!isMatch) {
      return res.status(401).json({ message: "Tên đăng nhập hoặc mật khẩu không chính xác" });
    }

    // Kiểm tra tài khoản có bị khóa không
    if (!admin.isActive) {
      return res.status(403).json({ message: "Tài khoản đã bị khóa" });
    }

    // Tạo access token
    const accessToken = _jsonwebtoken.default.sign(
      {
        userId: admin._id,
        role: admin.role,
        permissions: admin.permissions
      },
      process.env.JWT_SECRET_ACCESS,
      { expiresIn: "1d" }
    );

    // Tạo refresh token
    const refreshToken = _jsonwebtoken.default.sign(
      { userId: admin._id },
      process.env.JWT_REFRESH_SECRET,
      { expiresIn: "7d" }
    );

    // Xóa tất cả refresh token cũ của admin
    await _RefreshToken.default.deleteMany({
      userId: admin._id,
      userModel: "Admin"
    });

    // Lưu refresh token mới
    await _RefreshToken.default.create({
      userId: admin._id,
      userModel: "Admin",
      token: refreshToken,
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    });

    // Cập nhật thời gian đăng nhập cuối
    admin.lastLogin = new Date();
    await admin.save();

    // Trả về thông tin admin và token
    res.status(200).json({
      accessToken,
      refreshToken,
      userId: admin._id,
      role: admin.role,
      permissions: admin.permissions,
      fullName: admin.fullName,
      message: "Đăng nhập thành công"
    });
  } catch (error) {
    console.error("Admin login error:", error);
    res.status(500).json({ message: "Lỗi server khi đăng nhập" });
  }
};exports.adminLogin = adminLogin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYWRtaW5Nb2RlbCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2JjcnlwdGpzIiwiX2pzb253ZWJ0b2tlbiIsIl9kb3RlbnYiLCJfUmVmcmVzaFRva2VuIiwiZSIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiZG90ZW52IiwiY29uZmlnIiwiYWRtaW5Mb2dpbiIsInJlcSIsInJlcyIsInVzZXJOYW1lIiwicGFzc3dvcmQiLCJib2R5IiwiYWRtaW4iLCJBZG1pbiIsImZpbmRPbmUiLCJzdGF0dXMiLCJqc29uIiwibWVzc2FnZSIsImlzTWF0Y2giLCJjb21wYXJlUGFzc3dvcmQiLCJpc0FjdGl2ZSIsImFjY2Vzc1Rva2VuIiwiand0Iiwic2lnbiIsInVzZXJJZCIsIl9pZCIsInJvbGUiLCJwZXJtaXNzaW9ucyIsInByb2Nlc3MiLCJlbnYiLCJKV1RfU0VDUkVUX0FDQ0VTUyIsImV4cGlyZXNJbiIsInJlZnJlc2hUb2tlbiIsIkpXVF9SRUZSRVNIX1NFQ1JFVCIsIlJlZnJlc2hUb2tlbiIsImRlbGV0ZU1hbnkiLCJ1c2VyTW9kZWwiLCJjcmVhdGUiLCJ0b2tlbiIsImV4cGlyZXNBdCIsIkRhdGUiLCJub3ciLCJsYXN0TG9naW4iLCJzYXZlIiwiZnVsbE5hbWUiLCJlcnJvciIsImNvbnNvbGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL0NvbnRyb2xsZXIvYWRtaW5BdXRoQ29udHJvbGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQWRtaW4gZnJvbSBcIi4uL01vZGVsL2FkbWluTW9kZWwuanNcIjtcclxuaW1wb3J0IGJjcnlwdCBmcm9tIFwiYmNyeXB0anNcIjtcclxuaW1wb3J0IGp3dCBmcm9tIFwianNvbndlYnRva2VuXCI7XHJcbmltcG9ydCBkb3RlbnYgZnJvbSBcImRvdGVudlwiO1xyXG5pbXBvcnQgUmVmcmVzaFRva2VuIGZyb20gXCIuLi9Nb2RlbC9SZWZyZXNoVG9rZW4uanNcIjtcclxuXHJcbmRvdGVudi5jb25maWcoKTtcclxuXHJcbmV4cG9ydCBjb25zdCBhZG1pbkxvZ2luID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHsgdXNlck5hbWUsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgLy8gVMOsbSBhZG1pbiB0aGVvIHVzZXJuYW1lXHJcbiAgICAgICAgY29uc3QgYWRtaW4gPSBhd2FpdCBBZG1pbi5maW5kT25lKHsgdXNlck5hbWUgfSk7XHJcbiAgICAgICAgaWYgKCFhZG1pbikge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBtZXNzYWdlOiBcIlTDqm4gxJHEg25nIG5o4bqtcCBob+G6t2MgbeG6rXQga2jhuql1IGtow7RuZyBjaMOtbmggeMOhY1wiIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gS2nhu4NtIHRyYSBt4bqtdCBraOG6qXVcclxuICAgICAgICBjb25zdCBpc01hdGNoID0gYXdhaXQgYWRtaW4uY29tcGFyZVBhc3N3b3JkKHBhc3N3b3JkKTtcclxuICAgICAgICBpZiAoIWlzTWF0Y2gpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgbWVzc2FnZTogXCJUw6puIMSRxINuZyBuaOG6rXAgaG/hurdjIG3huq10IGto4bqpdSBraMO0bmcgY2jDrW5oIHjDoWNcIiB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIGPDsyBi4buLIGtow7NhIGtow7RuZ1xyXG4gICAgICAgIGlmICghYWRtaW4uaXNBY3RpdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogXCJUw6BpIGtob+G6o24gxJHDoyBi4buLIGtow7NhXCIgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBU4bqhbyBhY2Nlc3MgdG9rZW5cclxuICAgICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGp3dC5zaWduKFxyXG4gICAgICAgICAgICB7IFxyXG4gICAgICAgICAgICAgICAgdXNlcklkOiBhZG1pbi5faWQsXHJcbiAgICAgICAgICAgICAgICByb2xlOiBhZG1pbi5yb2xlLFxyXG4gICAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IGFkbWluLnBlcm1pc3Npb25zXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVRfQUNDRVNTLFxyXG4gICAgICAgICAgICB7IGV4cGlyZXNJbjogXCIxZFwiIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBU4bqhbyByZWZyZXNoIHRva2VuXHJcbiAgICAgICAgY29uc3QgcmVmcmVzaFRva2VuID0gand0LnNpZ24oXHJcbiAgICAgICAgICAgIHsgdXNlcklkOiBhZG1pbi5faWQgfSxcclxuICAgICAgICAgICAgcHJvY2Vzcy5lbnYuSldUX1JFRlJFU0hfU0VDUkVULFxyXG4gICAgICAgICAgICB7IGV4cGlyZXNJbjogXCI3ZFwiIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBYw7NhIHThuqV0IGPhuqMgcmVmcmVzaCB0b2tlbiBjxakgY+G7p2EgYWRtaW5cclxuICAgICAgICBhd2FpdCBSZWZyZXNoVG9rZW4uZGVsZXRlTWFueSh7XHJcbiAgICAgICAgICAgIHVzZXJJZDogYWRtaW4uX2lkLFxyXG4gICAgICAgICAgICB1c2VyTW9kZWw6IFwiQWRtaW5cIlxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBMxrB1IHJlZnJlc2ggdG9rZW4gbeG7m2lcclxuICAgICAgICBhd2FpdCBSZWZyZXNoVG9rZW4uY3JlYXRlKHtcclxuICAgICAgICAgICAgdXNlcklkOiBhZG1pbi5faWQsXHJcbiAgICAgICAgICAgIHVzZXJNb2RlbDogXCJBZG1pblwiLFxyXG4gICAgICAgICAgICB0b2tlbjogcmVmcmVzaFRva2VuLFxyXG4gICAgICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKERhdGUubm93KCkgKyA3ICogMjQgKiA2MCAqIDYwICogMTAwMCkgLy8gNyBkYXlzXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIEPhuq1wIG5o4bqtdCB0aOG7nWkgZ2lhbiDEkcSDbmcgbmjhuq1wIGN14buRaVxyXG4gICAgICAgIGFkbWluLmxhc3RMb2dpbiA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgYXdhaXQgYWRtaW4uc2F2ZSgpO1xyXG5cclxuICAgICAgICAvLyBUcuG6oyB24buBIHRow7RuZyB0aW4gYWRtaW4gdsOgIHRva2VuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBhY2Nlc3NUb2tlbixcclxuICAgICAgICAgICAgcmVmcmVzaFRva2VuLFxyXG4gICAgICAgICAgICB1c2VySWQ6IGFkbWluLl9pZCxcclxuICAgICAgICAgICAgcm9sZTogYWRtaW4ucm9sZSxcclxuICAgICAgICAgICAgcGVybWlzc2lvbnM6IGFkbWluLnBlcm1pc3Npb25zLFxyXG4gICAgICAgICAgICBmdWxsTmFtZTogYWRtaW4uZnVsbE5hbWUsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwixJDEg25nIG5o4bqtcCB0aMOgbmggY8O0bmdcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwiQWRtaW4gbG9naW4gZXJyb3I6XCIsIGVycm9yKTtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IFwiTOG7l2kgc2VydmVyIGtoaSDEkcSDbmcgbmjhuq1wXCIgfSk7XHJcbiAgICB9XHJcbn07ICJdLCJtYXBwaW5ncyI6InVHQUFBLElBQUFBLFdBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFNBQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFFLGFBQUEsR0FB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