"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _mongoose = _interopRequireDefault(require("mongoose"));

const bestSellingProductSchema = new _mongoose.default.Schema(
  {
    productId: {
      type: _mongoose.default.Schema.Types.ObjectId,
      ref: "Product",
      required: true
    },
    productName: { type: String, required: true },
    productCategory: { type: String, required: true },
    productPrice: { type: Number, required: true },
    productImage: { type: String },
    soldCount: { type: Number, default: 0 },
    totalRevenue: { type: Number, default: 0 },
    lastSoldDate: { type: Date, default: Date.now },
    lastOrderId: {
      type: _mongoose.default.Schema.Types.ObjectId,
      ref: "Order"
    },
    monthlySales: [{
      month: { type: Number }, // 0-11 (tháng trong năm)
      year: { type: Number },
      count: { type: Number, default: 0 },
      revenue: { type: Number, default: 0 }
    }]
  },
  { timestamps: true }
);

// Phương thức để cập nhật số lượng đã bán và doanh thu
bestSellingProductSchema.statics.updateSalesData = async function (productId, productInfo, quantity, orderId) {
  try {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    // Tìm hoặc tạo bản ghi sản phẩm bán chạy
    let bestSellingProduct = await this.findOne({ productId });

    if (!bestSellingProduct) {
      // Nếu không tìm thấy, tạo mới
      bestSellingProduct = new this({
        productId,
        productName: productInfo.productName,
        productCategory: productInfo.productCategory,
        productPrice: productInfo.productPrice,
        productImage: productInfo.productImages && productInfo.productImages.length > 0 ? productInfo.productImages[0] : '',
        soldCount: quantity,
        totalRevenue: productInfo.productPrice * quantity,
        lastSoldDate: now,
        lastOrderId: orderId,
        monthlySales: [{
          month: currentMonth,
          year: currentYear,
          count: quantity,
          revenue: productInfo.productPrice * quantity
        }]
      });
    } else {
      // Nếu đã tồn tại, cập nhật thông tin
      bestSellingProduct.soldCount += quantity;
      bestSellingProduct.totalRevenue += productInfo.productPrice * quantity;
      bestSellingProduct.lastSoldDate = now;
      bestSellingProduct.lastOrderId = orderId;

      // Cập nhật doanh số hàng tháng
      const monthlyRecord = bestSellingProduct.monthlySales.find(
        (record) => record.month === currentMonth && record.year === currentYear
      );

      if (monthlyRecord) {
        monthlyRecord.count += quantity;
        monthlyRecord.revenue += productInfo.productPrice * quantity;
      } else {
        bestSellingProduct.monthlySales.push({
          month: currentMonth,
          year: currentYear,
          count: quantity,
          revenue: productInfo.productPrice * quantity
        });
      }
    }

    await bestSellingProduct.save();
    return bestSellingProduct;
  } catch (error) {
    console.error("Lỗi khi cập nhật thông tin sản phẩm bán chạy:", error);
    throw error;
  }
};

// Phương thức để lấy sản phẩm bán chạy nhất trong khoảng thời gian
bestSellingProductSchema.statics.getBestSellers = async function (limit = 10, period = 'all') {
  try {
    let query = {};

    if (period !== 'all') {
      const now = new Date();
      const startDate = new Date();

      // Thiết lập thời gian tìm kiếm
      switch (period) {
        case 'day':
          startDate.setDate(now.getDate() - 1);
          break;
        case 'week':
          startDate.setDate(now.getDate() - 7);
          break;
        case 'month':
          startDate.setMonth(now.getMonth() - 1);
          break;
        case 'year':
          startDate.setFullYear(now.getFullYear() - 1);
          break;
      }

      query.lastSoldDate = { $gte: startDate };
    }

    // Tìm sản phẩm bán chạy nhất, giới hạn số lượng kết quả
    const bestSellers = await this.find(query).
    sort({ soldCount: -1 }).
    limit(limit).
    populate('productId', 'productName productPrice productStatus productImages productDiscount productStock productCategory');

    // Nếu không có sản phẩm bán chạy, tạo dữ liệu bán chạy từ sản phẩm thông thường
    if (bestSellers.length === 0) {
      // Import Product model
      const Product = _mongoose.default.model('Product');

      // Tìm sản phẩm thông thường
      const normalProducts = await Product.find({
        productStatus: { $ne: 'Hết hàng' },
        productStock: { $gt: 0 }
      }).
      sort({ createdAt: -1 }).
      limit(limit);

      // Chuyển đổi sản phẩm thông thường thành định dạng BestSellingProduct
      return normalProducts.map((product) => {
        return {
          _id: new _mongoose.default.Types.ObjectId(),
          productId: product,
          productName: product.productName,
          productCategory: product.productCategory,
          productPrice: product.productPrice,
          productImage: product.productImages && product.productImages.length > 0 ? product.productImages[0] : '',
          soldCount: Math.floor(Math.random() * 50) + 1, // Tạo số lượng bán ngẫu nhiên từ 1-50
          totalRevenue: product.productPrice * (Math.floor(Math.random() * 50) + 1),
          lastSoldDate: new Date(),
          monthlySales: [{
            month: new Date().getMonth(),
            year: new Date().getFullYear(),
            count: Math.floor(Math.random() * 50) + 1,
            revenue: product.productPrice * (Math.floor(Math.random() * 50) + 1)
          }]
        };
      });
    }

    return bestSellers;
  } catch (error) {
    console.error("Lỗi khi lấy danh sách sản phẩm bán chạy:", error);
    throw error;
  }
};

const BestSellingProduct = _mongoose.default.model("BestSellingProduct", bestSellingProductSchema);var _default = exports.default =

BestSellingProduct;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbW9uZ29vc2UiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImJlc3RTZWxsaW5nUHJvZHVjdFNjaGVtYSIsIm1vbmdvb3NlIiwiU2NoZW1hIiwicHJvZHVjdElkIiwidHlwZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCJyZWYiLCJyZXF1aXJlZCIsInByb2R1Y3ROYW1lIiwiU3RyaW5nIiwicHJvZHVjdENhdGVnb3J5IiwicHJvZHVjdFByaWNlIiwiTnVtYmVyIiwicHJvZHVjdEltYWdlIiwic29sZENvdW50IiwiZGVmYXVsdCIsInRvdGFsUmV2ZW51ZSIsImxhc3RTb2xkRGF0ZSIsIkRhdGUiLCJub3ciLCJsYXN0T3JkZXJJZCIsIm1vbnRobHlTYWxlcyIsIm1vbnRoIiwieWVhciIsImNvdW50IiwicmV2ZW51ZSIsInRpbWVzdGFtcHMiLCJzdGF0aWNzIiwidXBkYXRlU2FsZXNEYXRhIiwicHJvZHVjdEluZm8iLCJxdWFudGl0eSIsIm9yZGVySWQiLCJjdXJyZW50TW9udGgiLCJnZXRNb250aCIsImN1cnJlbnRZZWFyIiwiZ2V0RnVsbFllYXIiLCJiZXN0U2VsbGluZ1Byb2R1Y3QiLCJmaW5kT25lIiwicHJvZHVjdEltYWdlcyIsImxlbmd0aCIsIm1vbnRobHlSZWNvcmQiLCJmaW5kIiwicmVjb3JkIiwicHVzaCIsInNhdmUiLCJlcnJvciIsImNvbnNvbGUiLCJnZXRCZXN0U2VsbGVycyIsImxpbWl0IiwicGVyaW9kIiwicXVlcnkiLCJzdGFydERhdGUiLCJzZXREYXRlIiwiZ2V0RGF0ZSIsInNldE1vbnRoIiwic2V0RnVsbFllYXIiLCIkZ3RlIiwiYmVzdFNlbGxlcnMiLCJzb3J0IiwicG9wdWxhdGUiLCJQcm9kdWN0IiwibW9kZWwiLCJub3JtYWxQcm9kdWN0cyIsInByb2R1Y3RTdGF0dXMiLCIkbmUiLCJwcm9kdWN0U3RvY2siLCIkZ3QiLCJjcmVhdGVkQXQiLCJtYXAiLCJwcm9kdWN0IiwiX2lkIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwiQmVzdFNlbGxpbmdQcm9kdWN0IiwiX2RlZmF1bHQiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL01vZGVsL0Jlc3RTZWxsaW5nUHJvZHVjdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UgZnJvbSBcIm1vbmdvb3NlXCI7XHJcblxyXG5jb25zdCBiZXN0U2VsbGluZ1Byb2R1Y3RTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKFxyXG4gIHtcclxuICAgIHByb2R1Y3RJZDogeyBcclxuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCBcclxuICAgICAgcmVmOiBcIlByb2R1Y3RcIiwgXHJcbiAgICAgIHJlcXVpcmVkOiB0cnVlIFxyXG4gICAgfSxcclxuICAgIHByb2R1Y3ROYW1lOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcclxuICAgIHByb2R1Y3RDYXRlZ29yeTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXHJcbiAgICBwcm9kdWN0UHJpY2U6IHsgdHlwZTogTnVtYmVyLCByZXF1aXJlZDogdHJ1ZSB9LFxyXG4gICAgcHJvZHVjdEltYWdlOiB7IHR5cGU6IFN0cmluZyB9LFxyXG4gICAgc29sZENvdW50OiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCB9LFxyXG4gICAgdG90YWxSZXZlbnVlOiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCB9LFxyXG4gICAgbGFzdFNvbGREYXRlOiB7IHR5cGU6IERhdGUsIGRlZmF1bHQ6IERhdGUubm93IH0sXHJcbiAgICBsYXN0T3JkZXJJZDogeyBcclxuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLCBcclxuICAgICAgcmVmOiBcIk9yZGVyXCIgXHJcbiAgICB9LFxyXG4gICAgbW9udGhseVNhbGVzOiBbe1xyXG4gICAgICBtb250aDogeyB0eXBlOiBOdW1iZXIgfSwgLy8gMC0xMSAodGjDoW5nIHRyb25nIG7Eg20pXHJcbiAgICAgIHllYXI6IHsgdHlwZTogTnVtYmVyIH0sXHJcbiAgICAgIGNvdW50OiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCB9LFxyXG4gICAgICByZXZlbnVlOiB7IHR5cGU6IE51bWJlciwgZGVmYXVsdDogMCB9XHJcbiAgICB9XVxyXG4gIH0sXHJcbiAgeyB0aW1lc3RhbXBzOiB0cnVlIH1cclxuKTtcclxuXHJcbi8vIFBoxrDGoW5nIHRo4bupYyDEkeG7gyBj4bqtcCBuaOG6rXQgc+G7kSBsxrDhu6NuZyDEkcOjIGLDoW4gdsOgIGRvYW5oIHRodVxyXG5iZXN0U2VsbGluZ1Byb2R1Y3RTY2hlbWEuc3RhdGljcy51cGRhdGVTYWxlc0RhdGEgPSBhc3luYyBmdW5jdGlvbihwcm9kdWN0SWQsIHByb2R1Y3RJbmZvLCBxdWFudGl0eSwgb3JkZXJJZCkge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xyXG4gICAgY29uc3QgY3VycmVudE1vbnRoID0gbm93LmdldE1vbnRoKCk7XHJcbiAgICBjb25zdCBjdXJyZW50WWVhciA9IG5vdy5nZXRGdWxsWWVhcigpO1xyXG4gICAgXHJcbiAgICAvLyBUw6xtIGhv4bq3YyB04bqhbyBi4bqjbiBnaGkgc+G6o24gcGjhuqltIGLDoW4gY2jhuqF5XHJcbiAgICBsZXQgYmVzdFNlbGxpbmdQcm9kdWN0ID0gYXdhaXQgdGhpcy5maW5kT25lKHsgcHJvZHVjdElkIH0pO1xyXG4gICAgXHJcbiAgICBpZiAoIWJlc3RTZWxsaW5nUHJvZHVjdCkge1xyXG4gICAgICAvLyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXksIHThuqFvIG3hu5tpXHJcbiAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdCA9IG5ldyB0aGlzKHtcclxuICAgICAgICBwcm9kdWN0SWQsXHJcbiAgICAgICAgcHJvZHVjdE5hbWU6IHByb2R1Y3RJbmZvLnByb2R1Y3ROYW1lLFxyXG4gICAgICAgIHByb2R1Y3RDYXRlZ29yeTogcHJvZHVjdEluZm8ucHJvZHVjdENhdGVnb3J5LFxyXG4gICAgICAgIHByb2R1Y3RQcmljZTogcHJvZHVjdEluZm8ucHJvZHVjdFByaWNlLFxyXG4gICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdEluZm8ucHJvZHVjdEltYWdlcyAmJiBwcm9kdWN0SW5mby5wcm9kdWN0SW1hZ2VzLmxlbmd0aCA+IDAgPyBwcm9kdWN0SW5mby5wcm9kdWN0SW1hZ2VzWzBdIDogJycsXHJcbiAgICAgICAgc29sZENvdW50OiBxdWFudGl0eSxcclxuICAgICAgICB0b3RhbFJldmVudWU6IHByb2R1Y3RJbmZvLnByb2R1Y3RQcmljZSAqIHF1YW50aXR5LFxyXG4gICAgICAgIGxhc3RTb2xkRGF0ZTogbm93LFxyXG4gICAgICAgIGxhc3RPcmRlcklkOiBvcmRlcklkLFxyXG4gICAgICAgIG1vbnRobHlTYWxlczogW3tcclxuICAgICAgICAgIG1vbnRoOiBjdXJyZW50TW9udGgsXHJcbiAgICAgICAgICB5ZWFyOiBjdXJyZW50WWVhcixcclxuICAgICAgICAgIGNvdW50OiBxdWFudGl0eSxcclxuICAgICAgICAgIHJldmVudWU6IHByb2R1Y3RJbmZvLnByb2R1Y3RQcmljZSAqIHF1YW50aXR5XHJcbiAgICAgICAgfV1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBO4bq/dSDEkcOjIHThu5NuIHThuqFpLCBj4bqtcCBuaOG6rXQgdGjDtG5nIHRpblxyXG4gICAgICBiZXN0U2VsbGluZ1Byb2R1Y3Quc29sZENvdW50ICs9IHF1YW50aXR5O1xyXG4gICAgICBiZXN0U2VsbGluZ1Byb2R1Y3QudG90YWxSZXZlbnVlICs9IHByb2R1Y3RJbmZvLnByb2R1Y3RQcmljZSAqIHF1YW50aXR5O1xyXG4gICAgICBiZXN0U2VsbGluZ1Byb2R1Y3QubGFzdFNvbGREYXRlID0gbm93O1xyXG4gICAgICBiZXN0U2VsbGluZ1Byb2R1Y3QubGFzdE9yZGVySWQgPSBvcmRlcklkO1xyXG4gICAgICBcclxuICAgICAgLy8gQ+G6rXAgbmjhuq10IGRvYW5oIHPhu5EgaMOgbmcgdGjDoW5nXHJcbiAgICAgIGNvbnN0IG1vbnRobHlSZWNvcmQgPSBiZXN0U2VsbGluZ1Byb2R1Y3QubW9udGhseVNhbGVzLmZpbmQoXHJcbiAgICAgICAgcmVjb3JkID0+IHJlY29yZC5tb250aCA9PT0gY3VycmVudE1vbnRoICYmIHJlY29yZC55ZWFyID09PSBjdXJyZW50WWVhclxyXG4gICAgICApO1xyXG4gICAgICBcclxuICAgICAgaWYgKG1vbnRobHlSZWNvcmQpIHtcclxuICAgICAgICBtb250aGx5UmVjb3JkLmNvdW50ICs9IHF1YW50aXR5O1xyXG4gICAgICAgIG1vbnRobHlSZWNvcmQucmV2ZW51ZSArPSBwcm9kdWN0SW5mby5wcm9kdWN0UHJpY2UgKiBxdWFudGl0eTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBiZXN0U2VsbGluZ1Byb2R1Y3QubW9udGhseVNhbGVzLnB1c2goe1xyXG4gICAgICAgICAgbW9udGg6IGN1cnJlbnRNb250aCxcclxuICAgICAgICAgIHllYXI6IGN1cnJlbnRZZWFyLFxyXG4gICAgICAgICAgY291bnQ6IHF1YW50aXR5LFxyXG4gICAgICAgICAgcmV2ZW51ZTogcHJvZHVjdEluZm8ucHJvZHVjdFByaWNlICogcXVhbnRpdHlcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhd2FpdCBiZXN0U2VsbGluZ1Byb2R1Y3Quc2F2ZSgpO1xyXG4gICAgcmV0dXJuIGJlc3RTZWxsaW5nUHJvZHVjdDtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBz4bqjbiBwaOG6qW0gYsOhbiBjaOG6oXk6XCIsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIFBoxrDGoW5nIHRo4bupYyDEkeG7gyBs4bqleSBz4bqjbiBwaOG6qW0gYsOhbiBjaOG6oXkgbmjhuqV0IHRyb25nIGtob+G6o25nIHRo4budaSBnaWFuXHJcbmJlc3RTZWxsaW5nUHJvZHVjdFNjaGVtYS5zdGF0aWNzLmdldEJlc3RTZWxsZXJzID0gYXN5bmMgZnVuY3Rpb24obGltaXQgPSAxMCwgcGVyaW9kID0gJ2FsbCcpIHtcclxuICB0cnkge1xyXG4gICAgbGV0IHF1ZXJ5ID0ge307XHJcbiAgICBcclxuICAgIGlmIChwZXJpb2QgIT09ICdhbGwnKSB7XHJcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBUaGnhur90IGzhuq1wIHRo4budaSBnaWFuIHTDrG0ga2nhur9tXHJcbiAgICAgIHN3aXRjaCAocGVyaW9kKSB7XHJcbiAgICAgICAgY2FzZSAnZGF5JzpcclxuICAgICAgICAgIHN0YXJ0RGF0ZS5zZXREYXRlKG5vdy5nZXREYXRlKCkgLSAxKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3dlZWsnOlxyXG4gICAgICAgICAgc3RhcnREYXRlLnNldERhdGUobm93LmdldERhdGUoKSAtIDcpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnbW9udGgnOlxyXG4gICAgICAgICAgc3RhcnREYXRlLnNldE1vbnRoKG5vdy5nZXRNb250aCgpIC0gMSk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICd5ZWFyJzpcclxuICAgICAgICAgIHN0YXJ0RGF0ZS5zZXRGdWxsWWVhcihub3cuZ2V0RnVsbFllYXIoKSAtIDEpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHF1ZXJ5Lmxhc3RTb2xkRGF0ZSA9IHsgJGd0ZTogc3RhcnREYXRlIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFTDrG0gc+G6o24gcGjhuqltIGLDoW4gY2jhuqF5IG5o4bqldCwgZ2nhu5tpIGjhuqFuIHPhu5EgbMaw4bujbmcga+G6v3QgcXXhuqNcclxuICAgIGNvbnN0IGJlc3RTZWxsZXJzID0gYXdhaXQgdGhpcy5maW5kKHF1ZXJ5KVxyXG4gICAgICAuc29ydCh7IHNvbGRDb3VudDogLTEgfSlcclxuICAgICAgLmxpbWl0KGxpbWl0KVxyXG4gICAgICAucG9wdWxhdGUoJ3Byb2R1Y3RJZCcsICdwcm9kdWN0TmFtZSBwcm9kdWN0UHJpY2UgcHJvZHVjdFN0YXR1cyBwcm9kdWN0SW1hZ2VzIHByb2R1Y3REaXNjb3VudCBwcm9kdWN0U3RvY2sgcHJvZHVjdENhdGVnb3J5Jyk7XHJcbiAgICBcclxuICAgIC8vIE7hur91IGtow7RuZyBjw7Mgc+G6o24gcGjhuqltIGLDoW4gY2jhuqF5LCB04bqhbyBk4buvIGxp4buHdSBiw6FuIGNo4bqheSB04burIHPhuqNuIHBo4bqpbSB0aMO0bmcgdGjGsOG7nW5nXHJcbiAgICBpZiAoYmVzdFNlbGxlcnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIC8vIEltcG9ydCBQcm9kdWN0IG1vZGVsXHJcbiAgICAgIGNvbnN0IFByb2R1Y3QgPSBtb25nb29zZS5tb2RlbCgnUHJvZHVjdCcpO1xyXG4gICAgICBcclxuICAgICAgLy8gVMOsbSBz4bqjbiBwaOG6qW0gdGjDtG5nIHRoxrDhu51uZ1xyXG4gICAgICBjb25zdCBub3JtYWxQcm9kdWN0cyA9IGF3YWl0IFByb2R1Y3QuZmluZCh7XHJcbiAgICAgICAgcHJvZHVjdFN0YXR1czogeyAkbmU6ICdI4bq/dCBow6BuZycgfSxcclxuICAgICAgICBwcm9kdWN0U3RvY2s6IHsgJGd0OiAwIH1cclxuICAgICAgfSlcclxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXHJcbiAgICAgIC5saW1pdChsaW1pdCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBDaHV54buDbiDEkeG7lWkgc+G6o24gcGjhuqltIHRow7RuZyB0aMaw4budbmcgdGjDoG5oIMSR4buLbmggZOG6oW5nIEJlc3RTZWxsaW5nUHJvZHVjdFxyXG4gICAgICByZXR1cm4gbm9ybWFsUHJvZHVjdHMubWFwKHByb2R1Y3QgPT4ge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBfaWQ6IG5ldyBtb25nb29zZS5UeXBlcy5PYmplY3RJZCgpLFxyXG4gICAgICAgICAgcHJvZHVjdElkOiBwcm9kdWN0LFxyXG4gICAgICAgICAgcHJvZHVjdE5hbWU6IHByb2R1Y3QucHJvZHVjdE5hbWUsXHJcbiAgICAgICAgICBwcm9kdWN0Q2F0ZWdvcnk6IHByb2R1Y3QucHJvZHVjdENhdGVnb3J5LFxyXG4gICAgICAgICAgcHJvZHVjdFByaWNlOiBwcm9kdWN0LnByb2R1Y3RQcmljZSxcclxuICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC5wcm9kdWN0SW1hZ2VzICYmIHByb2R1Y3QucHJvZHVjdEltYWdlcy5sZW5ndGggPiAwID8gcHJvZHVjdC5wcm9kdWN0SW1hZ2VzWzBdIDogJycsXHJcbiAgICAgICAgICBzb2xkQ291bnQ6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDUwKSArIDEsIC8vIFThuqFvIHPhu5EgbMaw4bujbmcgYsOhbiBuZ+G6q3Ugbmhpw6puIHThu6sgMS01MFxyXG4gICAgICAgICAgdG90YWxSZXZlbnVlOiBwcm9kdWN0LnByb2R1Y3RQcmljZSAqIChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1MCkgKyAxKSxcclxuICAgICAgICAgIGxhc3RTb2xkRGF0ZTogbmV3IERhdGUoKSxcclxuICAgICAgICAgIG1vbnRobHlTYWxlczogW3tcclxuICAgICAgICAgICAgbW9udGg6IG5ldyBEYXRlKCkuZ2V0TW9udGgoKSxcclxuICAgICAgICAgICAgeWVhcjogbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLFxyXG4gICAgICAgICAgICBjb3VudDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNTApICsgMSxcclxuICAgICAgICAgICAgcmV2ZW51ZTogcHJvZHVjdC5wcm9kdWN0UHJpY2UgKiAoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNTApICsgMSlcclxuICAgICAgICAgIH1dXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBiZXN0U2VsbGVycztcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkzhu5dpIGtoaSBs4bqleSBkYW5oIHPDoWNoIHPhuqNuIHBo4bqpbSBiw6FuIGNo4bqheTpcIiwgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG59O1xyXG5cclxuY29uc3QgQmVzdFNlbGxpbmdQcm9kdWN0ID0gbW9uZ29vc2UubW9kZWwoXCJCZXN0U2VsbGluZ1Byb2R1Y3RcIiwgYmVzdFNlbGxpbmdQcm9kdWN0U2NoZW1hKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IEJlc3RTZWxsaW5nUHJvZHVjdDsgIl0sIm1hcHBpbmdzIjoieUxBQUEsSUFBQUEsU0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBOztBQUVBLE1BQU1DLHdCQUF3QixHQUFHLElBQUlDLGlCQUFRLENBQUNDLE1BQU07RUFDbEQ7SUFDRUMsU0FBUyxFQUFFO01BQ1RDLElBQUksRUFBRUgsaUJBQVEsQ0FBQ0MsTUFBTSxDQUFDRyxLQUFLLENBQUNDLFFBQVE7TUFDcENDLEdBQUcsRUFBRSxTQUFTO01BQ2RDLFFBQVEsRUFBRTtJQUNaLENBQUM7SUFDREMsV0FBVyxFQUFFLEVBQUVMLElBQUksRUFBRU0sTUFBTSxFQUFFRixRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0NHLGVBQWUsRUFBRSxFQUFFUCxJQUFJLEVBQUVNLE1BQU0sRUFBRUYsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pESSxZQUFZLEVBQUUsRUFBRVIsSUFBSSxFQUFFUyxNQUFNLEVBQUVMLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5Q00sWUFBWSxFQUFFLEVBQUVWLElBQUksRUFBRU0sTUFBTSxDQUFDLENBQUM7SUFDOUJLLFNBQVMsRUFBRSxFQUFFWCxJQUFJLEVB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