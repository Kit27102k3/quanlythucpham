"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _mongoose = _interopRequireDefault(require("mongoose"));function _interopRequireDefault(e) {return e && e.__esModule ? e : { default: e };}

const bestSellingProductSchema = new _mongoose.default.Schema(
  {
    productId: {
      type: _mongoose.default.Schema.Types.ObjectId,
      ref: "Product",
      required: true
    },
    productName: { type: String, required: true },
    productCategory: { type: String, required: true },
    productPrice: { type: Number, required: true },
    productImage: { type: String },
    soldCount: { type: Number, default: 0 },
    totalRevenue: { type: Number, default: 0 },
    lastSoldDate: { type: Date, default: Date.now },
    lastOrderId: {
      type: _mongoose.default.Schema.Types.ObjectId,
      ref: "Order"
    },
    monthlySales: [{
      month: { type: Number }, // 0-11 (tháng trong năm)
      year: { type: Number },
      count: { type: Number, default: 0 },
      revenue: { type: Number, default: 0 }
    }]
  },
  { timestamps: true }
);

// Phương thức để cập nhật số lượng đã bán và doanh thu
bestSellingProductSchema.statics.updateSalesData = async function (productId, productInfo, quantity, orderId) {
  try {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    // Tìm hoặc tạo bản ghi sản phẩm bán chạy
    let bestSellingProduct = await this.findOne({ productId });

    if (!bestSellingProduct) {
      // Nếu không tìm thấy, tạo mới
      bestSellingProduct = new this({
        productId,
        productName: productInfo.productName,
        productCategory: productInfo.productCategory,
        productPrice: productInfo.productPrice,
        productImage: productInfo.productImages && productInfo.productImages.length > 0 ? productInfo.productImages[0] : '',
        soldCount: quantity,
        totalRevenue: productInfo.productPrice * quantity,
        lastSoldDate: now,
        lastOrderId: orderId,
        monthlySales: [{
          month: currentMonth,
          year: currentYear,
          count: quantity,
          revenue: productInfo.productPrice * quantity
        }]
      });
    } else {
      // Nếu đã tồn tại, cập nhật thông tin
      bestSellingProduct.soldCount += quantity;
      bestSellingProduct.totalRevenue += productInfo.productPrice * quantity;
      bestSellingProduct.lastSoldDate = now;
      bestSellingProduct.lastOrderId = orderId;

      // Cập nhật doanh số hàng tháng
      const monthlyRecord = bestSellingProduct.monthlySales.find(
        (record) => record.month === currentMonth && record.year === currentYear
      );

      if (monthlyRecord) {
        monthlyRecord.count += quantity;
        monthlyRecord.revenue += productInfo.productPrice * quantity;
      } else {
        bestSellingProduct.monthlySales.push({
          month: currentMonth,
          year: currentYear,
          count: quantity,
          revenue: productInfo.productPrice * quantity
        });
      }
    }

    await bestSellingProduct.save();
    return bestSellingProduct;
  } catch (error) {
    console.error("Lỗi khi cập nhật thông tin sản phẩm bán chạy:", error);
    throw error;
  }
};

// Phương thức để lấy sản phẩm bán chạy nhất trong khoảng thời gian
bestSellingProductSchema.statics.getBestSellers = async function (limit = 10, period = 'all') {
  try {
    let query = {};

    if (period !== 'all') {
      const now = new Date();
      const startDate = new Date();

      // Thiết lập thời gian tìm kiếm
      switch (period) {
        case 'day':
          startDate.setDate(now.getDate() - 1);
          break;
        case 'week':
          startDate.setDate(now.getDate() - 7);
          break;
        case 'month':
          startDate.setMonth(now.getMonth() - 1);
          break;
        case 'year':
          startDate.setFullYear(now.getFullYear() - 1);
          break;
      }

      query.lastSoldDate = { $gte: startDate };
    }

    // Tìm sản phẩm bán chạy nhất, giới hạn số lượng kết quả
    const bestSellers = await this.find(query).
    sort({ soldCount: -1 }).
    limit(limit).
    populate('productId', 'productName productPrice productStatus productImages productDiscount productStock productCategory');

    // Nếu không có sản phẩm bán chạy, tạo dữ liệu bán chạy từ sản phẩm thông thường
    if (bestSellers.length === 0) {
      // Import Product model
      const Product = _mongoose.default.model('Product');

      // Tìm sản phẩm thông thường
      const normalProducts = await Product.find({
        productStatus: { $ne: 'Hết hàng' },
        productStock: { $gt: 0 }
      }).
      sort({ createdAt: -1 }).
      limit(limit);

      // Chuyển đổi sản phẩm thông thường thành định dạng BestSellingProduct
      return normalProducts.map((product) => {
        return {
          _id: new _mongoose.default.Types.ObjectId(),
          productId: product,
          productName: product.productName,
          productCategory: product.productCategory,
          productPrice: product.productPrice,
          productImage: product.productImages && product.productImages.length > 0 ? product.productImages[0] : '',
          soldCount: Math.floor(Math.random() * 50) + 1, // Tạo số lượng bán ngẫu nhiên từ 1-50
          totalRevenue: product.productPrice * (Math.floor(Math.random() * 50) + 1),
          lastSoldDate: new Date(),
          monthlySales: [{
            month: new Date().getMonth(),
            year: new Date().getFullYear(),
            count: Math.floor(Math.random() * 50) + 1,
            revenue: product.productPrice * (Math.floor(Math.random() * 50) + 1)
          }]
        };
      });
    }

    return bestSellers;
  } catch (error) {
    console.error("Lỗi khi lấy danh sách sản phẩm bán chạy:", error);
    throw error;
  }
};

const BestSellingProduct = _mongoose.default.model("BestSellingProduct", bestSellingProductSchema);var _default = exports.default =

BestSellingProduct;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbW9uZ29vc2UiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImUiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImJlc3RTZWxsaW5nUHJvZHVjdFNjaGVtYSIsIm1vbmdvb3NlIiwiU2NoZW1hIiwicHJvZHVjdElkIiwidHlwZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCJyZWYiLCJyZXF1aXJlZCIsInByb2R1Y3ROYW1lIiwiU3RyaW5nIiwicHJvZHVjdENhdGVnb3J5IiwicHJvZHVjdFByaWNlIiwiTnVtYmVyIiwicHJvZHVjdEltYWdlIiwic29sZENvdW50IiwidG90YWxSZXZlbnVlIiwibGFzdFNvbGREYXRlIiwiRGF0ZSIsIm5vdyIsImxhc3RPcmRlcklkIiwibW9udGhseVNhbGVzIiwibW9udGgiLCJ5ZWFyIiwiY291bnQiLCJyZXZlbnVlIiwidGltZXN0YW1wcyIsInN0YXRpY3MiLCJ1cGRhdGVTYWxlc0RhdGEiLCJwcm9kdWN0SW5mbyIsInF1YW50aXR5Iiwib3JkZXJJZCIsImN1cnJlbnRNb250aCIsImdldE1vbnRoIiwiY3VycmVudFllYXIiLCJnZXRGdWxsWWVhciIsImJlc3RTZWxsaW5nUHJvZHVjdCIsImZpbmRPbmUiLCJwcm9kdWN0SW1hZ2VzIiwibGVuZ3RoIiwibW9udGhseVJlY29yZCIsImZpbmQiLCJyZWNvcmQiLCJwdXNoIiwic2F2ZSIsImVycm9yIiwiY29uc29sZSIsImdldEJlc3RTZWxsZXJzIiwibGltaXQiLCJwZXJpb2QiLCJxdWVyeSIsInN0YXJ0RGF0ZSIsInNldERhdGUiLCJnZXREYXRlIiwic2V0TW9udGgiLCJzZXRGdWxsWWVhciIsIiRndGUiLCJiZXN0U2VsbGVycyIsInNvcnQiLCJwb3B1bGF0ZSIsIlByb2R1Y3QiLCJtb2RlbCIsIm5vcm1hbFByb2R1Y3RzIiwicHJvZHVjdFN0YXR1cyIsIiRuZSIsInByb2R1Y3RTdG9jayIsIiRndCIsImNyZWF0ZWRBdCIsIm1hcCIsInByb2R1Y3QiLCJfaWQiLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJCZXN0U2VsbGluZ1Byb2R1Y3QiLCJfZGVmYXVsdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvTW9kZWwvQmVzdFNlbGxpbmdQcm9kdWN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcclxuXHJcbmNvbnN0IGJlc3RTZWxsaW5nUHJvZHVjdFNjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoXHJcbiAge1xyXG4gICAgcHJvZHVjdElkOiB7IFxyXG4gICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIFxyXG4gICAgICByZWY6IFwiUHJvZHVjdFwiLCBcclxuICAgICAgcmVxdWlyZWQ6IHRydWUgXHJcbiAgICB9LFxyXG4gICAgcHJvZHVjdE5hbWU6IHsgdHlwZTogU3RyaW5nLCByZXF1aXJlZDogdHJ1ZSB9LFxyXG4gICAgcHJvZHVjdENhdGVnb3J5OiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUgfSxcclxuICAgIHByb2R1Y3RQcmljZTogeyB0eXBlOiBOdW1iZXIsIHJlcXVpcmVkOiB0cnVlIH0sXHJcbiAgICBwcm9kdWN0SW1hZ2U6IHsgdHlwZTogU3RyaW5nIH0sXHJcbiAgICBzb2xkQ291bnQ6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwIH0sXHJcbiAgICB0b3RhbFJldmVudWU6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwIH0sXHJcbiAgICBsYXN0U29sZERhdGU6IHsgdHlwZTogRGF0ZSwgZGVmYXVsdDogRGF0ZS5ub3cgfSxcclxuICAgIGxhc3RPcmRlcklkOiB7IFxyXG4gICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIFxyXG4gICAgICByZWY6IFwiT3JkZXJcIiBcclxuICAgIH0sXHJcbiAgICBtb250aGx5U2FsZXM6IFt7XHJcbiAgICAgIG1vbnRoOiB7IHR5cGU6IE51bWJlciB9LCAvLyAwLTExICh0aMOhbmcgdHJvbmcgbsSDbSlcclxuICAgICAgeWVhcjogeyB0eXBlOiBOdW1iZXIgfSxcclxuICAgICAgY291bnQ6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwIH0sXHJcbiAgICAgIHJldmVudWU6IHsgdHlwZTogTnVtYmVyLCBkZWZhdWx0OiAwIH1cclxuICAgIH1dXHJcbiAgfSxcclxuICB7IHRpbWVzdGFtcHM6IHRydWUgfVxyXG4pO1xyXG5cclxuLy8gUGjGsMahbmcgdGjhu6ljIMSR4buDIGPhuq1wIG5o4bqtdCBz4buRIGzGsOG7o25nIMSRw6MgYsOhbiB2w6AgZG9hbmggdGh1XHJcbmJlc3RTZWxsaW5nUHJvZHVjdFNjaGVtYS5zdGF0aWNzLnVwZGF0ZVNhbGVzRGF0YSA9IGFzeW5jIGZ1bmN0aW9uKHByb2R1Y3RJZCwgcHJvZHVjdEluZm8sIHF1YW50aXR5LCBvcmRlcklkKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgICBjb25zdCBjdXJyZW50TW9udGggPSBub3cuZ2V0TW9udGgoKTtcclxuICAgIGNvbnN0IGN1cnJlbnRZZWFyID0gbm93LmdldEZ1bGxZZWFyKCk7XHJcbiAgICBcclxuICAgIC8vIFTDrG0gaG/hurdjIHThuqFvIGLhuqNuIGdoaSBz4bqjbiBwaOG6qW0gYsOhbiBjaOG6oXlcclxuICAgIGxldCBiZXN0U2VsbGluZ1Byb2R1Y3QgPSBhd2FpdCB0aGlzLmZpbmRPbmUoeyBwcm9kdWN0SWQgfSk7XHJcbiAgICBcclxuICAgIGlmICghYmVzdFNlbGxpbmdQcm9kdWN0KSB7XHJcbiAgICAgIC8vIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSwgdOG6oW8gbeG7m2lcclxuICAgICAgYmVzdFNlbGxpbmdQcm9kdWN0ID0gbmV3IHRoaXMoe1xyXG4gICAgICAgIHByb2R1Y3RJZCxcclxuICAgICAgICBwcm9kdWN0TmFtZTogcHJvZHVjdEluZm8ucHJvZHVjdE5hbWUsXHJcbiAgICAgICAgcHJvZHVjdENhdGVnb3J5OiBwcm9kdWN0SW5mby5wcm9kdWN0Q2F0ZWdvcnksXHJcbiAgICAgICAgcHJvZHVjdFByaWNlOiBwcm9kdWN0SW5mby5wcm9kdWN0UHJpY2UsXHJcbiAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0SW5mby5wcm9kdWN0SW1hZ2VzICYmIHByb2R1Y3RJbmZvLnByb2R1Y3RJbWFnZXMubGVuZ3RoID4gMCA/IHByb2R1Y3RJbmZvLnByb2R1Y3RJbWFnZXNbMF0gOiAnJyxcclxuICAgICAgICBzb2xkQ291bnQ6IHF1YW50aXR5LFxyXG4gICAgICAgIHRvdGFsUmV2ZW51ZTogcHJvZHVjdEluZm8ucHJvZHVjdFByaWNlICogcXVhbnRpdHksXHJcbiAgICAgICAgbGFzdFNvbGREYXRlOiBub3csXHJcbiAgICAgICAgbGFzdE9yZGVySWQ6IG9yZGVySWQsXHJcbiAgICAgICAgbW9udGhseVNhbGVzOiBbe1xyXG4gICAgICAgICAgbW9udGg6IGN1cnJlbnRNb250aCxcclxuICAgICAgICAgIHllYXI6IGN1cnJlbnRZZWFyLFxyXG4gICAgICAgICAgY291bnQ6IHF1YW50aXR5LFxyXG4gICAgICAgICAgcmV2ZW51ZTogcHJvZHVjdEluZm8ucHJvZHVjdFByaWNlICogcXVhbnRpdHlcclxuICAgICAgICB9XVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIE7hur91IMSRw6MgdOG7k24gdOG6oWksIGPhuq1wIG5o4bqtdCB0aMO0bmcgdGluXHJcbiAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdC5zb2xkQ291bnQgKz0gcXVhbnRpdHk7XHJcbiAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdC50b3RhbFJldmVudWUgKz0gcHJvZHVjdEluZm8ucHJvZHVjdFByaWNlICogcXVhbnRpdHk7XHJcbiAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdC5sYXN0U29sZERhdGUgPSBub3c7XHJcbiAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdC5sYXN0T3JkZXJJZCA9IG9yZGVySWQ7XHJcbiAgICAgIFxyXG4gICAgICAvLyBD4bqtcCBuaOG6rXQgZG9hbmggc+G7kSBow6BuZyB0aMOhbmdcclxuICAgICAgY29uc3QgbW9udGhseVJlY29yZCA9IGJlc3RTZWxsaW5nUHJvZHVjdC5tb250aGx5U2FsZXMuZmluZChcclxuICAgICAgICByZWNvcmQgPT4gcmVjb3JkLm1vbnRoID09PSBjdXJyZW50TW9udGggJiYgcmVjb3JkLnllYXIgPT09IGN1cnJlbnRZZWFyXHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAobW9udGhseVJlY29yZCkge1xyXG4gICAgICAgIG1vbnRobHlSZWNvcmQuY291bnQgKz0gcXVhbnRpdHk7XHJcbiAgICAgICAgbW9udGhseVJlY29yZC5yZXZlbnVlICs9IHByb2R1Y3RJbmZvLnByb2R1Y3RQcmljZSAqIHF1YW50aXR5O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGJlc3RTZWxsaW5nUHJvZHVjdC5tb250aGx5U2FsZXMucHVzaCh7XHJcbiAgICAgICAgICBtb250aDogY3VycmVudE1vbnRoLFxyXG4gICAgICAgICAgeWVhcjogY3VycmVudFllYXIsXHJcbiAgICAgICAgICBjb3VudDogcXVhbnRpdHksXHJcbiAgICAgICAgICByZXZlbnVlOiBwcm9kdWN0SW5mby5wcm9kdWN0UHJpY2UgKiBxdWFudGl0eVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGF3YWl0IGJlc3RTZWxsaW5nUHJvZHVjdC5zYXZlKCk7XHJcbiAgICByZXR1cm4gYmVzdFNlbGxpbmdQcm9kdWN0O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiTOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHPhuqNuIHBo4bqpbSBiw6FuIGNo4bqheTpcIiwgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gUGjGsMahbmcgdGjhu6ljIMSR4buDIGzhuqV5IHPhuqNuIHBo4bqpbSBiw6FuIGNo4bqheSBuaOG6pXQgdHJvbmcga2hv4bqjbmcgdGjhu51pIGdpYW5cclxuYmVzdFNlbGxpbmdQcm9kdWN0U2NoZW1hLnN0YXRpY3MuZ2V0QmVzdFNlbGxlcnMgPSBhc3luYyBmdW5jdGlvbihsaW1pdCA9IDEwLCBwZXJpb2QgPSAnYWxsJykge1xyXG4gIHRyeSB7XHJcbiAgICBsZXQgcXVlcnkgPSB7fTtcclxuICAgIFxyXG4gICAgaWYgKHBlcmlvZCAhPT0gJ2FsbCcpIHtcclxuICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICAgICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRoaeG6v3QgbOG6rXAgdGjhu51pIGdpYW4gdMOsbSBraeG6v21cclxuICAgICAgc3dpdGNoIChwZXJpb2QpIHtcclxuICAgICAgICBjYXNlICdkYXknOlxyXG4gICAgICAgICAgc3RhcnREYXRlLnNldERhdGUobm93LmdldERhdGUoKSAtIDEpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnd2Vlayc6XHJcbiAgICAgICAgICBzdGFydERhdGUuc2V0RGF0ZShub3cuZ2V0RGF0ZSgpIC0gNyk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdtb250aCc6XHJcbiAgICAgICAgICBzdGFydERhdGUuc2V0TW9udGgobm93LmdldE1vbnRoKCkgLSAxKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3llYXInOlxyXG4gICAgICAgICAgc3RhcnREYXRlLnNldEZ1bGxZZWFyKG5vdy5nZXRGdWxsWWVhcigpIC0gMSk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcXVlcnkubGFzdFNvbGREYXRlID0geyAkZ3RlOiBzdGFydERhdGUgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gVMOsbSBz4bqjbiBwaOG6qW0gYsOhbiBjaOG6oXkgbmjhuqV0LCBnaeG7m2kgaOG6oW4gc+G7kSBsxrDhu6NuZyBr4bq/dCBxdeG6o1xyXG4gICAgY29uc3QgYmVzdFNlbGxlcnMgPSBhd2FpdCB0aGlzLmZpbmQocXVlcnkpXHJcbiAgICAgIC5zb3J0KHsgc29sZENvdW50OiAtMSB9KVxyXG4gICAgICAubGltaXQobGltaXQpXHJcbiAgICAgIC5wb3B1bGF0ZSgncHJvZHVjdElkJywgJ3Byb2R1Y3ROYW1lIHByb2R1Y3RQcmljZSBwcm9kdWN0U3RhdHVzIHByb2R1Y3RJbWFnZXMgcHJvZHVjdERpc2NvdW50IHByb2R1Y3RTdG9jayBwcm9kdWN0Q2F0ZWdvcnknKTtcclxuICAgIFxyXG4gICAgLy8gTuG6v3Uga2jDtG5nIGPDsyBz4bqjbiBwaOG6qW0gYsOhbiBjaOG6oXksIHThuqFvIGThu68gbGnhu4d1IGLDoW4gY2jhuqF5IHThu6sgc+G6o24gcGjhuqltIHRow7RuZyB0aMaw4budbmdcclxuICAgIGlmIChiZXN0U2VsbGVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgLy8gSW1wb3J0IFByb2R1Y3QgbW9kZWxcclxuICAgICAgY29uc3QgUHJvZHVjdCA9IG1vbmdvb3NlLm1vZGVsKCdQcm9kdWN0Jyk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBUw6xtIHPhuqNuIHBo4bqpbSB0aMO0bmcgdGjGsOG7nW5nXHJcbiAgICAgIGNvbnN0IG5vcm1hbFByb2R1Y3RzID0gYXdhaXQgUHJvZHVjdC5maW5kKHtcclxuICAgICAgICBwcm9kdWN0U3RhdHVzOiB7ICRuZTogJ0jhur90IGjDoG5nJyB9LFxyXG4gICAgICAgIHByb2R1Y3RTdG9jazogeyAkZ3Q6IDAgfVxyXG4gICAgICB9KVxyXG4gICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcclxuICAgICAgLmxpbWl0KGxpbWl0KTtcclxuICAgICAgXHJcbiAgICAgIC8vIENodXnhu4NuIMSR4buVaSBz4bqjbiBwaOG6qW0gdGjDtG5nIHRoxrDhu51uZyB0aMOgbmggxJHhu4tuaCBk4bqhbmcgQmVzdFNlbGxpbmdQcm9kdWN0XHJcbiAgICAgIHJldHVybiBub3JtYWxQcm9kdWN0cy5tYXAocHJvZHVjdCA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIF9pZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKCksXHJcbiAgICAgICAgICBwcm9kdWN0SWQ6IHByb2R1Y3QsXHJcbiAgICAgICAgICBwcm9kdWN0TmFtZTogcHJvZHVjdC5wcm9kdWN0TmFtZSxcclxuICAgICAgICAgIHByb2R1Y3RDYXRlZ29yeTogcHJvZHVjdC5wcm9kdWN0Q2F0ZWdvcnksXHJcbiAgICAgICAgICBwcm9kdWN0UHJpY2U6IHByb2R1Y3QucHJvZHVjdFByaWNlLFxyXG4gICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LnByb2R1Y3RJbWFnZXMgJiYgcHJvZHVjdC5wcm9kdWN0SW1hZ2VzLmxlbmd0aCA+IDAgPyBwcm9kdWN0LnByb2R1Y3RJbWFnZXNbMF0gOiAnJyxcclxuICAgICAgICAgIHNvbGRDb3VudDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNTApICsgMSwgLy8gVOG6oW8gc+G7kSBsxrDhu6NuZyBiw6FuIG5n4bqrdSBuaGnDqm4gdOG7qyAxLTUwXHJcbiAgICAgICAgICB0b3RhbFJldmVudWU6IHByb2R1Y3QucHJvZHVjdFByaWNlICogKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDUwKSArIDEpLFxyXG4gICAgICAgICAgbGFzdFNvbGREYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgICAgbW9udGhseVNhbGVzOiBbe1xyXG4gICAgICAgICAgICBtb250aDogbmV3IERhdGUoKS5nZXRNb250aCgpLFxyXG4gICAgICAgICAgICB5ZWFyOiBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCksXHJcbiAgICAgICAgICAgIGNvdW50OiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1MCkgKyAxLFxyXG4gICAgICAgICAgICByZXZlbnVlOiBwcm9kdWN0LnByb2R1Y3RQcmljZSAqIChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1MCkgKyAxKVxyXG4gICAgICAgICAgfV1cclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIGJlc3RTZWxsZXJzO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggc+G6o24gcGjhuqltIGLDoW4gY2jhuqF5OlwiLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn07XHJcblxyXG5jb25zdCBCZXN0U2VsbGluZ1Byb2R1Y3QgPSBtb25nb29zZS5tb2RlbChcIkJlc3RTZWxsaW5nUHJvZHVjdFwiLCBiZXN0U2VsbGluZ1Byb2R1Y3RTY2hlbWEpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgQmVzdFNlbGxpbmdQcm9kdWN0OyAiXSwibWFwcGluZ3MiOiJvR0FBQSxJQUFBQSxTQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUEsY0FBZ0MsU0FBQUQsdUJBQUFFLENBQUEsVUFBQUEsQ0FBQSxJQUFBQSxDQUFBLENBQUFDLFVBQUEsR0FBQUQsQ0FBQSxLQUFBRSxPQUFBLEVBQUFGLENBQUE7O0FBRWhDLE1BQU1HLHdCQUF3QixHQUFHLElBQUlDLGlCQUFRLENBQUNDLE1BQU07RUFDbEQ7SUFDRUMsU0FBUyxFQUFFO01BQ1RDLElBQUksRUFBRUgsaUJBQVEsQ0FBQ0MsTUFBTSxDQUFDRyxLQUFLLENBQUNDLFFBQVE7TUFDcENDLEdBQUcsRUFBRSxTQUFTO01BQ2RDLFFBQVEsRUFBRTtJQUNaLENBQUM7SUFDREMsV0FBVyxFQUFFLEVBQUVMLElBQUksRUFBRU0sTUFBTSxFQUFFRixRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0NHLGVBQWUsRUFBRSxFQUFFUCxJQUFJLEVBQUVNLE1BQU0sRUFBRUYsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pESSxZQUFZLEVBQUUsRUFBRVIsSUFBSSxFQUFFUyxNQUFNLEVB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